<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
"-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="clubMapper">
	
	
	<resultMap type="club" id="clubResultSet">
		<result column="CLUB_NO"			 property="clubNo" />
		<result column="CLUB_NO"		 	 property="userNo" />
		<result column="CLUB_NAME"			 property="clubName" />
		<result column="CLUB_LIMIT"			 property="clubLimit" />
		<result column="CLUB_CREATEDATE"	 property="clubCreatedate" />
		<result column="CLUB_DISCRIPT"       property="clubDiscript" />
		<result column="CLUB_LOCATION" 		 property="clubLocation" />
		<result column="CLUB_STATUS" 		 property="clubStatus" />
		<result column="CLUB_IMG" 			 property="clubImg" />
		<result column="newCount"			 property="newCount" />
		<result column="CLUB_COUNT"			 property="clubCount" />
		<result column="LIKECOUNT"			 property="likeCount" />
		<result column="MEMCOUNT"			 property="memCount" />
		<result column="enrollDate"			 property="enrollDate" />
		<result column="OPENCOUNT"			 property="openCount" />
	</resultMap>
	
	<!-- 모임 페이지 리스트 종 갯수 조회  -->
	<select id="selectListCount" resultType="_int">
		SELECT 
				COUNT(*)
		  FROM
		  		club
  		 WHERE
  		 		club_status = 'Y'
	</select>
	
	<!-- 모임 리스트 페이지에 뿌려줄 정보  조회 -->
	<select id="selectList" resultMap="clubResultSet">
		SELECT 
			   CLUB_NO
			  ,USER_NO
			  ,CLUB_NAME
			  ,CLUB_LIMIT
			  ,CLUB_CREATEDATE
			  ,CLUB_DISCRIPT
			  ,CLUB_IMG
			  ,CLUB_LOCATION
			  ,CLUB_IMG
			  ,CLUB_COUNT
              ,CASE WHEN
                      (select to_date(SYSDATE, 'YY-MM-DD') from dual) - (select to_date(CLUB_CREATEDATE, 'YY-MM-DD') from dual) <![CDATA[ > ]]> 30 THEN 0
                   WHEN
                      (select to_date(SYSDATE, 'YY-MM-DD') from dual) - (select to_date(CLUB_CREATEDATE, 'YY-MM-DD') from dual) <![CDATA[ < ]]> 30 THEN 1
                   END AS "newCount"
	  	  FROM
	  	  	   CLUB
  	  	 WHERE
  	  	 	   CLUB_STATUS = 'Y'
 	  	 ORDER
 	  	    BY
 	  	       CLUB_NO DESC
	
	</select>
	
	<!-- 모임 생성 쿼리문  
		CLUB_CREATEDATE / CLUB_STATUS 컬럼 빼고 쓰니까 
		ORA-01747: invalid user.table.column, table.column, or column specification
		해당 오류 발생.. ㅠ 	
	 -->
	<insert id="insertGroup" parameterType="club">
		INSERT
		  INTO 
		        CLUB
		       (
		        CLUB_NO,
		        USER_NO,
			    CLUB_NAME,
			    CLUB_LIMIT,
				CLUB_CREATEDATE,
				CLUB_DISCRIPT,
				CLUB_IMG,
				CLUB_LOCATION,
				CLUB_STATUS
		       )
	    VALUES 
			   (
			   SEQ_CNO.NEXTVAL
			  ,#{userNo}
			  ,#{clubName}
			  ,#{clubLimit}
			  ,SYSDATE
			  ,#{clubDiscript}
			  ,#{clubImg}
			  ,#{clubLocation}
			  ,'Y'
			   )
	</insert>
	
	<!-- Group List 조회수 Update -->
	<update id="increaseCount" parameterType="_int">
		UPDATE 
				"GROUP"
		   SET
				GROUP_COUNT = ( GROUP_COUNT + 1 )
		 WHERE
		 		GROUP_NO = #{ groupNo }
		   AND
		   		GROUP_STATUS = 'Y'				
	</update>
	
	<!-- Club List Detail Select -->
	<select id="selectDetailGroup" parameterType="_int" resultMap="clubResultSet" >
		SELECT 
				GROUP_NO
			   ,M.NICKNAME
			   ,GROUP_TITLE
			   ,GROUP_NUM
			   ,GROUP_CREATEDATE
			   ,GROUP_DESCRIBE
			   ,GROUP_DAY
			   ,GROUP_LOCATION
			   ,GROUP_IMG
			   ,GROUP_COUNT
               ,(select count(*) from group_like where group_no = 13) as "LIKECOUNT"			   
		 FROM
		       "GROUP" G
		 JOIN
		       MEMBER M ON(G.USER_NO = M.USER_NO)
		WHERE
		       GROUP_NO = ${ groupNo }
		  AND 
		       GROUP_STATUS = 'Y'      
		                 	   
	</select>
	
	
	<!-- Club General List Select -->
	<select id="clubGeneral" parameterType="_int" resultMap="clubResultSet">
		SELECT 
				C.CLUB_NO
			   ,C.CLUB_NAME
			   ,C.CLUB_IMG
			   ,C.CLUB_LOCATION
			   ,C.ENROLL_DATE as "enrollDate"
			   ,COUNT(C.CLUB_NO) AS "MEMCOUNT"
		  FROM
		  		CLUB_MEMBER M 
	  	  JOIN	
			   (SELECT 
						C.CLUB_NO
					   ,CLUB_NAME
					   ,CLUB_IMG
					   ,CLUB_LOCATION
					   ,M.ENROLL_DATE
				  FROM 
				  		CLUB C
				  JOIN  
				  		CLUB_MEMBER M ON(C.CLUB_NO = M.CLUB_NO)
				 WHERE
				 		M.USER_NO = #{ userNo }) C ON (C.CLUB_NO = M.CLUB_NO)
		  GROUP
		     BY
		     	 C.CLUB_NO
		     	,CLUB_NAME
		     	,CLUB_IMG
		     	,CLUB_LOCATION
		     	,C.ENROLL_DATE
	     ORDER
	        BY
	        	C.ENROLL_DATE DESC
	</select>
	
	<!--  update / delete resultType 필요없음  -->
	<delete id="ajaxDeleteClub" parameterType="club">
		DELETE
		  FROM  
		       CLUB_MEMBER
	     WHERE
	     	   CLUB_NO = #{ clubNo }
	       AND	   
		       USER_NO = #{ userNo }
	</delete>
	
	<!-- 모임 관리자 모임 정보 SELECT 쿼리  -->
	<select id="clubAdmin" parameterType="_int" resultMap="clubResultSet">
		SELECT
	            C.CLUB_NO
	           ,C.USER_NO
	           ,C.CLUB_NAME
	           ,C.CLUB_LIMIT
	           ,C.CLUB_CREATEDATE
	           ,C.CLUB_DISCRIPT
	           ,C.CLUB_IMG
	           ,C.CLUB_LOCATION
	           ,C.CLUB_STATUS
	           ,C.CLUB_COUNT
	           ,MEMCOUNT
	           ,LIKECOUNT
	           ,COUNT(CO.CLUB_NO) "OPENCOUNT"       
		 FROM 
		  		CLUB_OPEN CO      
		RIGHT
	   	 JOIN                 
     		   (
     		    SELECT  
			            C.CLUB_NO
			           ,C.USER_NO
			           ,C.CLUB_NAME
			           ,C.CLUB_LIMIT
			           ,C.CLUB_CREATEDATE
			           ,C.CLUB_DISCRIPT
			           ,C.CLUB_IMG
			           ,C.CLUB_LOCATION
			           ,C.CLUB_STATUS
			           ,C.CLUB_COUNT
			           ,MEMCOUNT
			           ,COUNT(CL.CLUB_NO) "LIKECOUNT"     
			      FROM 
			            CLUB_LIKE CL
			     RIGHT
			      JOIN                 
			           (
			            SELECT 
			            	    C.CLUB_NO
					           ,C.USER_NO
					           ,C.CLUB_NAME
					           ,C.CLUB_LIMIT
					           ,C.CLUB_CREATEDATE
					           ,C.CLUB_DISCRIPT
					           ,C.CLUB_IMG
					           ,C.CLUB_LOCATION
					           ,C.CLUB_STATUS
					           ,C.CLUB_COUNT
			            	   ,COUNT(CM.CLUB_NO) "MEMCOUNT"
			              FROM 
			              		CLUB C
			              LEFT
			              JOIN
			                    CLUB_MEMBER CM ON (C.CLUB_NO = CM.CLUB_NO)
			             GROUP
			                BY
			            	    C.CLUB_NO
					           ,C.USER_NO
					           ,C.CLUB_NAME
					           ,C.CLUB_LIMIT
					           ,C.CLUB_CREATEDATE
					           ,C.CLUB_DISCRIPT
					           ,C.CLUB_IMG
					           ,C.CLUB_LOCATION
					           ,C.CLUB_STATUS
					           ,C.CLUB_COUNT
			            HAVING 
			            		C.USER_NO = #{ userNo }
			               AND 
			               		C.CLUB_STATUS ='Y' ) C ON (C.CLUB_NO = CL.CLUB_NO)
			      GROUP
			         BY 
	            	    C.CLUB_NO
			           ,C.USER_NO
			           ,C.CLUB_NAME
			           ,C.CLUB_LIMIT
			           ,C.CLUB_CREATEDATE
			           ,C.CLUB_DISCRIPT
			           ,C.CLUB_IMG
			           ,C.CLUB_LOCATION
			           ,C.CLUB_STATUS
			           ,C.CLUB_COUNT
			           , MEMCOUNT) C ON(C.CLUB_NO = CO.CLUB_NO)
		GROUP 
		   BY 
	            C.CLUB_NO
	           ,C.USER_NO
	           ,C.CLUB_NAME
	           ,C.CLUB_LIMIT
	           ,C.CLUB_CREATEDATE
	           ,C.CLUB_DISCRIPT
	           ,C.CLUB_IMG
	           ,C.CLUB_LOCATION
	           ,C.CLUB_STATUS
	           ,C.CLUB_COUNT
	           ,MEMCOUNT
	           ,LIKECOUNT	
	</select>	
	
	
	
	
</mapper>
