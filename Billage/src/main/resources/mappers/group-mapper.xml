<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
"-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="groupMapper">
	
	
	<resultMap type="group" id="groupResultSet">
		<result column="GROUP_NO" property="groupNo" />
		<result column="USER_NO" property="userNo" />
		<result column="GROUP_TITLE" property="groupTitle" />
		<result column="GROUP_NUM" property="groupNum" />
		<result column="GROUP_CREATEDATE" property="groupCreatedate" />
		<result column="GROUP_DESCRIBE" property="groupDescribe" />
		<result column="GROUP_DAY" property="groupDay" />
		<result column="GROUP_LOCATION" property="groupLocation" />
		<result column="GROUP_STATUS" property="groupStatus" />
		<result column="GROUP_IMG" property="groupImg" />
		<result column="newCount" property="newCount" />
		<result column="GROUP_COUNT" property="groupCount" />
		<result column="likeCount" property="likeCount" />
	</resultMap>
	
	<!-- 모임 페이지 리스트 종 갯수 조회  -->
	<select id="selectListCount" resultType="_int">
		SELECT 
				COUNT(*)
		  FROM
		  		"GROUP"
  		 WHERE
  		 		GROUP_STATUS = 'Y'
	</select>
	
	<!-- 모임 리스트 페이지에 뿌려줄 정보  조회 -->
	<select id="selectList" resultMap="groupResultSet">
		SELECT 
			   GROUP_NO
			  ,USER_NO
			  ,GROUP_TITLE
			  ,GROUP_NUM
			  ,GROUP_CREATEDATE
			  ,GROUP_DESCRIBE
			  ,GROUP_DAY
			  ,GROUP_LOCATION
			  ,GROUP_IMG
			  ,GROUP_COUNT
              ,CASE WHEN
                      (select to_date(SYSDATE, 'YY-MM-DD') from dual) - (select to_date(group_createdate, 'YY-MM-DD') from dual) <![CDATA[ > ]]> 30 THEN 0
                   WHEN
                      (select to_date(SYSDATE, 'YY-MM-DD') from dual) - (select to_date(group_createdate, 'YY-MM-DD') from dual) <![CDATA[ < ]]> 30 THEN 1
                   END AS "newCount"
	  	  FROM
	  	  	   "GROUP"
  	  	 WHERE
  	  	 	   GROUP_STATUS = 'Y'
 	  	 ORDER
 	  	    BY
 	  	       GROUP_NO DESC
	
	</select>
	
	<!-- 모임 생성 쿼리문  -->
	<insert id="insertGroup" parameterType="group">
		insert
		  into 
		       "GROUP"
		       (
		        GROUP_NO,
		        USER_NO,
			    GROUP_TITLE,
			    GROUP_NUM,
				GROUP_DESCRIBE,
				GROUP_DAY,
				GROUP_LOCATION,
				GROUP_IMG
		       )
	    values 
			   (
			   seq_gno.nextval
			  ,#{userNo}
			  ,#{groupTitle}
			  ,#{groupNum}
			  ,#{groupDescribe}
			  ,#{groupDay}
			  ,#{groupLocation}
			  ,#{groupImg}
			   )
	</insert>
	
	<!-- Group List 조회수 Update -->
	<update id="increaseCount" parameterType="_int">
		UPDATE 
				"GROUP"
		   SET
				GROUP_COUNT = ( GROUP_COUNT + 1 )
		 WHERE
		 		GROUP_NO = #{ groupNo }
		   AND
		   		GROUP_STATUS = 'Y'				
	</update>
	
	<!-- Group List Detail Select -->
	<select id="selectDetailGroup" parameterType="_int" resultMap="groupResultSet" >
		SELECT 
				GROUP_NO
			   ,M.NICKNAME
			   ,GROUP_TITLE
			   ,GROUP_NUM
			   ,GROUP_CREATEDATE
			   ,GROUP_DESCRIBE
			   ,GROUP_DAY
			   ,GROUP_LOCATION
			   ,GROUP_IMG
			   ,GROUP_COUNT
               ,(select count(*) from group_like where group_no = 13) as "likeCount"			   
		 FROM
		       "GROUP" G
		 JOIN
		       MEMBER M ON(G.USER_NO = M.USER_NO)
		WHERE
		       GROUP_NO = ${ groupNo }
		  AND 
		       GROUP_STATUS = 'Y'      
		                 	   
	</select>
	
</mapper>
