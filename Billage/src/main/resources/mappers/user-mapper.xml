<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
"-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="userMapper">

	<resultMap id="userResultSet" type="user">
		<result column="USER_ID" 			property="userId" />
		<result column="USER_PWD"			property="userPwd" />
		<result column="NAME"				property="name" />
		<result column="EMAIL"				property="email" />
		<result column="NICKNAME"			property="nickname" />
		<result column="PHONE"				property="phone" />
		<result column="BIRTH_DATE"			property="birthDate" />
		<result column="GENDER"				property="gender" />
		<result column="ADDRESS"			property="address" />
		<result column="DETAIL_ADDRESS"		property="detailAddress" />
		<result column="USER_GRADE"			property="userGrade" />
		<result column="USER_NO"			property="userNo" />
		<result column="ENROLL_DATE"		property="enrollDate" />
		<result column="PROFILE_IMG"		property="profileImg" />
		<result column="POINT"    			property="point" />
		<result column="STATUS"				property="status" />
	</resultMap>

	<resultMap type="club" id="groupResultSet">
		<result column="CLUB_NO" property="clubNo" />
		<result column="CLUB_NO" property="userNo" />
		<result column="CLUB_NAME" property="clubName" />
		<result column="CLUB_LIMIT" property="clubLimit" />
		<result column="CLUB_CREATEDATE" property="clubCreatedate" />
		<result column="CLUB_DISCRIPT" property="clubDiscript" />
		<result column="CLUB_LOCATION" property="clubLocation" />
		<result column="CLUB_STATUS" property="clubStatus" />
		<result column="CLUB_IMG" property="clubImg" />
		<result column="newCount" property="newCount" />
		<result column="CLUB_COUNT" property="clubCount" />
		<result column="likeCount" property="likeCount" />
	</resultMap>
	
	<resultMap id="inqResultSet" type="inquiry">
			<result column="inq_no"			property="inqNo" />
			<result column="user_no"		property="userNo" />
			<result column="inq_title"		property="inqTitle" />
			<result column="inq_content"	property="inqContent" />
			<result column="inq_type"		property="inqType" />
			<result column="inq_date"		property="inqDate" />
			<result column="inq_status"		property="inqStatus" />
			<result column="answer"			property="answer" />
	</resultMap>
	
	<!-- 회원가입용 쿼리문 -->
	<insert id="insertUser" parameterType="user">
		INSERT
		  INTO
			  MEMBER
			  (
			  	USER_NO,
				USER_ID,
				USER_PWD,
				NAME,
				EMAIL,
				NICKNAME,
				PHONE,
				BIRTH_DATE,
				GENDER,
				ADDRESS,
				DETAIL_ADDRESS
			  )
		VALUES
			  (
			  	SEQ_UNO.NEXTVAL,
			  	#{userId},
			  	#{userPwd},
			  	#{name},
			  	#{email},
			  	#{nickname},
			  	#{phone},
			  	#{birthDate},
			  	#{gender},
			  	#{address},
			  	#{detailAddress}
			  )		
	</insert>
	
	<!-- 로그인용 쿼리문 -->
	<select id="loginUser" parameterType="user" resultMap="userResultSet">
		SELECT
				USER_NO,
				USER_ID,
				USER_PWD,
				NAME,
				EMAIL,
				NICKNAME,
				PHONE,
				BIRTH_DATE,
				GENDER,
				ADDRESS,
				DETAIL_ADDRESS,
				ENROLL_DATE,
				PROFILE_IMG,
				USER_GRADE,
				( SELECT SUM(POINT_ADD) "POINT"
					 FROM POINT 
					 JOIN MEMBER M USING(USER_NO)
					 WHERE  M.USER_ID = #{ userId } ) "POINT",
				STATUS

		FROM
				MEMBER
		WHERE
				USER_ID = #{userId}
		AND
				STATUS = 'N'
	
	</select>
	
	<!-- id중복체크용 쿼리문 -->
	<select id="idCheck" resultType="_int">
		SELECT
				COUNT(*)
		FROM
				MEMBER
		WHERE 	
				USER_ID = #{checkId}
	</select>
	
	<!-- 연재요청 수락후 회원등급변경 -->
	<update id="updateUserGrade">
		update
				member
		set
				user_grade = '2'
		where
				user_no = #{ userNo }
	</update>

	<!-- 관리자 회원조회 총 몇명 세기 -->
	<select id="selectUserListCount" resultType="_int">
		select
				count(*)
		from
				member
	</select>
	
	<!-- 관리자 회원조회 쿼리문 -->
	<select id="selectUserList" resultMap="userResultSet">
		select
				user_no,
				user_id,
				nickname,
				email,
				enroll_date,
				user_grade,
				status
		from
				member
	</select>
	
	<!-- 관리자 모임조회 총 몇개 세기 -->
	<select id="selectGroupListCount" resultType="_int">
		select
				count(*)
		from
				CLUB
	</select>
	
	<!-- 관리자 모임조회 쿼리문 -->
	<select id="selectGroupList" resultMap="groupResultSet">
		select
				CLUB_NO,
				(select nickname from member m where m.user_no = c.user_no) as nickName,
				CLUB_NAME,
				CLUB_CREATEDATE,
				CLUB_STATUS
		from
				CLUB c
	</select>
	
	<!-- 닉네임 중복체크용 쿼리문 -->
	<select id="nicknameCheck" resultType="_int">
		SELECT
				COUNT(*)
		FROM
				MEMBER
		WHERE 	
				NICKNAME = #{checkNickname}
	</select>
	
	<!-- 개인정보수정 쿼리문 -->
	<update id="updateUser" parameterType="user">
		UPDATE
				MEMBER
		SET
				USER_ID = #{userId},
				NAME = #{name},
				NICKNAME = #{nickname},
				EMAIL = #{email},
				PHONE = #{phone},
				ADDRESS = #{address},
				DETAIL_ADDRESS = #{detailAddress},
				PROFILE_IMG = #{profileImg}
		WHERE
				USER_NO = #{userNo}
	</update>
	
	<!-- 회원탈퇴 쿼리문 -->
	<update id="deleteUser">
		UPDATE
				MEMBER
		SET
				STATUS = 'Y'
		WHERE
				USER_NO = #{userNo}
	</update>
	
	<!-- 문의 총 몇개 세기 -->
	<select id="selectInqListCount" resultType="_int">
		select
				count(*)
		from
				inquiry
	</select>
	
	<!-- 관리자 문의조회 쿼리문 -->
	<select id="selectInqList" resultMap="inqResultSet">
		select
				inq_no,
				(select nickname from member m where m.user_no = iq.user_no) as nickName,
				inq_type,
				inq_title,
				inq_date,
				inq_status
		from
				inquiry iq
	</select>
	
	<!-- 1:1문의 요청 쿼리문 -->
	<insert id="insertInq" parameterType="inquiry">
		insert
			into
				inquiry
				(
				inq_no,
				user_no,
				inq_title,
				inq_content,
				inq_type,
				inq_date,
				inq_status
				)
			values
				(
				seq_ino.nextval,
				#{userNo},
				#{inqTitle},
				#{inqContent},
				#{inqType},
				sysdate,
				'N'
				)
	</insert>
	
	<!-- 1:1문의 상세조회 쿼리문(일단은 관리자입장) -->
	<select id="selectInquiry" resultMap="inqResultSet">
		select
				inq_no,
				user_no,
				(select nickname from member m where m.user_no = iq.user_no) as nickName,
				inq_title,
				inq_content,
				inq_type,
				inq_date,
				inq_status,
				answer
		from
				inquiry iq
		where
				inq_no = #{ inqNo }
	</select>
	
	<!-- 1:1문의 답변 쿼리문 -->
	<update id="updateInquiry" parameterType="inquiry">
		update
				inquiry
		set
				answer = #{ answer },
				inq_status = 'Y'
		where
				inq_no = #{ inqNo }
	</update>
</mapper>